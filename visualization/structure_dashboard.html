<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Structure Dashboard - 2-3 HEPN Cas13</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
  <style>
    :root { --bg:#0f172a; --card:#1e3a5f; --accent:#38bdf8; --hepn:#22d3ee; --text:#f8fafc; --muted:#94a3b8; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 1.5rem; font-family: 'DM Sans', system-ui; background: var(--bg); color: var(--text); min-height: 100vh; }
    h1 { font-size: 1.5rem; margin: 0 0 0.5rem; }
    .sub { color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem; }
    .layout { display: grid; grid-template-columns: 1fr 400px; gap: 1.5rem; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    .viewer { width: 100%; height: 480px; background: #1e293b; border-radius: 8px; }
    .table-wrap { overflow-x: auto; max-height: 70vh; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th, td { padding: 0.4rem 0.6rem; text-align: left; border-bottom: 1px solid #334155; }
    th { color: var(--muted); font-weight: 500; position: sticky; top: 0; background: var(--bg); }
    tr:hover { background: #1e3a5f; }
    tr.selected { background: #1e3a5f; outline: 1px solid var(--accent); }
    .pct { font-variant-numeric: tabular-nums; }
    .no-pdb { color: var(--muted); font-style: italic; }
    .load-hint { color: var(--muted); font-size: 0.8rem; margin-top: 0.5rem; }
  </style>
</head>
<body>
  <h1>Structure Dashboard – 2-3 HEPN Cas13</h1>
  <p class="sub">Folding homology vs Cas13a/13b · Domain-colored 3D structure · Serve via HTTP to load PDBs</p>

  <div class="layout">
    <div>
      <div id="molviewer" class="viewer"></div>
      <p class="load-hint">Select a row to load structure. Serve from project root: python -m http.server 8000</p>
      <div id="domain-legend" style="margin-top:0.5rem;font-size:0.85rem;color:var(--muted)"></div>
      <div id="detail-panel" style="margin-top:0.75rem;padding:0.5rem;background:#1e293b;border-radius:6px;font-size:0.8rem;color:var(--muted)"></div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Family</th>
            <th>Len</th>
            <th>HEPN</th>
            <th>NUC</th>
            <th>REC</th>
            <th>Cas13a %</th>
            <th>Cas13b %</th>
            <th>RfxCas13d %</th>
            <th>Best</th>
            <th>SRA</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const DATA = {"rows": [], "domain_colors": {"PF05168": "#22d3ee", "PF01228": "#f97316", "PF18456": "#94a3b8"}, "lobe_colors": {"nuc": "#22d3ee", "rec": "#f97316"}};

    function renderTable() {
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";
      DATA.rows.forEach((r, i) => {
        const tr = document.createElement("tr");
        tr.dataset.id = r.id;
        tr.dataset.index = i;
        const sra = (r.sra_accession || "").slice(0, 12);
        tr.innerHTML = `<td>${r.id}</td><td>${r.family}</td><td>${r.length}</td><td>${r.hepn_count}</td>
          <td title="${r.nuc_summary || ''}">${(r.nuc_summary || '-').slice(0,20)}${(r.nuc_summary || '').length > 20 ? '…' : ''}</td>
          <td title="${r.rec_summary || ''}">${(r.rec_summary || '-').slice(0,20)}${(r.rec_summary || '').length > 20 ? '…' : ''}</td>
          <td class="pct">${r.cas13a != null ? r.cas13a + '%' : '-'}</td>
          <td class="pct">${r.cas13b != null ? r.cas13b + '%' : '-'}</td>
          <td class="pct">${r.cas13d != null ? r.cas13d + '%' : '-'}</td>
          <td>${r.best_match || '-'}</td>
          <td title="${r.sra_accession || ''}">${sra || '-'}</td>`;
        tr.addEventListener("click", () => selectRow(i));
        tbody.appendChild(tr);
      });
    }

    function selectRow(index) {
      document.querySelectorAll("#tbody tr").forEach(tr => tr.classList.remove("selected"));
      const tr = document.querySelector(`#tbody tr[data-index="${index}"]`);
      if (tr) tr.classList.add("selected");
      const row = DATA.rows[index];
      loadStructure(row);
      const dp = document.getElementById("detail-panel");
      const parts = [];
      if (row.sra_accession) parts.push(`<b>SRA:</b> ${row.sra_accession}`);
      if (row.repeat_domains) parts.push(`<b>CRISPR repeats:</b> ${row.repeat_domains}`);
      if (parts.length) dp.innerHTML = parts.join(" &nbsp;|&nbsp; ");
      else dp.innerHTML = "";
    }

    function loadStructure(row) {
      const viewer = document.getElementById("molviewer");
      const div = document.createElement("div");
      div.className = "viewer";
      div.style.width = "100%";
      div.style.height = "480px";
      viewer.parentNode.replaceChild(div, viewer);
      div.id = "molviewer";

      const view = $3Dmol.createViewer(div, { backgroundColor: "#1e293b" });

      if (!row.pdb_path) {
        view.addLabel("No PDB available", { position: { x: 0, y: 0, z: 0 }, backgroundColor: "transparent" });
        view.zoomTo();
        view.render();
        return;
      }

      // Fetch PDB - path relative to project root when served via http.server
      const base = window.location.pathname.includes("/visualization/") ? "../" : "./";
      const url = base + (row.pdb_path || "");
      fetch(url).then(res => res.text()).then(pdb => {
        view.addModel(pdb, "pdb");
        view.setStyle({}, { cartoon: { color: "spectrum" } });

        let legendParts = [];
        if ((row.domains || []).length > 0) {
          // Domain coloring from InterPro
          (row.domains || []).forEach(d => {
            const sig = (d.signature || "").split(".")[0];
            const color = DATA.domain_colors[sig] || "#64748b";
            view.setStyle({ resi: d.start + "-" + d.end }, { cartoon: { color: color } });
          });
          const legMap = { "PF05168": "HEPN (NUC)", "PF01228": "HEL (REC)", "PF18456": "WYL (REC)" };
          const used = [...new Set((row.domains || []).map(d => (d.signature || "").split(".")[0]))];
          legendParts = used.map(s => `<span style="color:${DATA.domain_colors[s] || '#64748b'}">&#9679;</span> ${legMap[s] || s}`);
        } else if ((row.nuc_spans || []).length > 0 || (row.rec_spans || []).length > 0) {
          // NUC/REC lobe coloring (1-based resi)
          (row.nuc_spans || []).forEach(([s,e]) => view.setStyle({ resi: (s+1) + "-" + e }, { cartoon: { color: DATA.lobe_colors.nuc } }));
          (row.rec_spans || []).forEach(([s,e]) => view.setStyle({ resi: (s+1) + "-" + e }, { cartoon: { color: DATA.lobe_colors.rec } }));
          legendParts = [`<span style="color:${DATA.lobe_colors.nuc}">&#9679;</span> NUC (nuclease)`, `<span style="color:${DATA.lobe_colors.rec}">&#9679;</span> REC (recognition)`];
        }

        view.zoomTo();
        view.render();

        const legend = document.getElementById("domain-legend");
        legend.innerHTML = legendParts.join(" ") || "";
      }).catch(() => {
        view.addLabel("Failed to load PDB", { position: { x: 0, y: 0, z: 0 }, backgroundColor: "transparent" });
        view.zoomTo();
        view.render();
      });
    }

    renderTable();
    if (DATA.rows.length) selectRow(0);
  </script>
</body>
</html>
